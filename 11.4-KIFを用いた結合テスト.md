結合テストとは、複数のモジュールを組み合わせ時に行うテストである。iOSにおけるテストは、主に単体テストと結合テストによってなっており、
単体テストについては前章などで紹介した通りだが、結合テストは画面の操作をシミュレートしてテストを行う。

結合テストを行うフレームワークとして、KIFとUIAutomationがある。それぞれについて特徴をまとめると

|         | UIAutomation  | KIF    |
|-------- | ------------- | ------ |
| 開発元   | Instrumentsの機能の一つ | Square, Inc が開発 |
| テストの記述方法 | JavaScript, シミュレータおよび実機の操作 |  Objective-C |
| 実行環境  | シミュレータ、実機、コマンドライン | シミュレータ、実機、コマンドライン |
| テスト可能な領域 | 実際に動かすことのできる範囲内のみ | プログラムとの連携可能 |

となる。この章では、より広範なテストを行うことのできるKIFについて、その導入法とテスト手法について紹介する。


## KIFの導入

既にあるプロジェクトに対してKIFを導入するフローを解説します。次のステップで導入することができます。

1. KIFテスト用のターゲットを追加
2. Cocoa PodsによるKIFのインストール
3. appDeleagteの修正

順に追って紹介していきます。


### 1. KIFテスト用のターゲットを追加

KIFでは、すでに動作するアプリケーションに対してテストを行うので、ターゲットは新規に作るのではなく、アプリケーションのターゲットを複製して利用します。
![ターゲットの複製](https://raw.github.com/mixi-inc/iOSTraining/master/Doc/Images/11.4/kif_1.png)

プロジェクトナビゲーターより、ターゲットを選択して、Duplicate(⌘+D)を行います。アラートが出てきますが、ここでは一番左のDuplicate Only を選択します。(右の選択肢はiPad用に複製する場合です)
![アラート](https://raw.github.com/mixi-inc/iOSTraining/master/Doc/Images/11.4/kif_2.png)

ターゲットを追加できたら、ターゲット名などを変更します。名前は適当で構いませんが、今回は "janken KIF" としました。またあわせて
build settings → Product name と scheme の名称も変更しました。この二つについては、見栄えの問題なので任意で構いません。

### 2. CocoaPodsを用いてインストール

インストールにはCocoaPodsを利用します。Podfileは次のようになります。
```
platform :ios

pod 'KIF', :head

```

完了したらインストールします
```
pod install
```

以前は依存関係が正しく解決できていなかったようですが、2013/05/17現在では問題ありません。(Xcode 4.6.2, OSX 10.8.2)

### appDelagateの修正

KIFによるテストは、appDelagateの `-application:didFinishLaunchingWithOptions:` にテスト開始のメソッドを追加することでテストを自動実行しています。

そのための下準備として、テストのコントローラを追加します。

新規ファイル作成より、KIFTestControllerを継承したクラスを作成します。ヘッダファイルはそのままで、.mファイルに次のように`initializeScenarios`を追加します

```
@implementation JankenTestController

- (void)initializeScenarios
{
    
}
@end
```

今回クラス名はJankenTestControllerとしました
以上でテストコントローラの作成は終了です。実際にテストを行う際は以下にテストシナリオを追加して行きます。

次にappDeleagteを修正します。ヘッダをインクルードしている箇所に、次のスニペットを挿入します。

```
#if RUN_KIF_TESTS
#import "JankenTestController.h"
#endif
```

そして、 `-application:didFinishLaunchingWithOptions:`内に次のコードを挿入します。
```
#if RUN_KIF_TESTS
    [[JankenTestController sharedInstance] startTestingWithCompletionBlock:^{
        exit([[JankenTestController sharedInstance] failureCount]);
    }];
#endif
```

以上で準備は完了です。スキーマをjanken KIF に変更して実行します。シミュレータが起動してすぐに終了すれば導入は完了です。



## テストの書き方

KIFによる結合テストはシナリオベースで行います。シナリオベースとはどういうことか、例えば次のような例が挙げられます。

ログインにおけるシナリオ

- まず、メールアドレス欄にメールアドレスを、パスワード欄にパスワードをそれぞれ入力する
- 次に、ログインボタンを押し認証が始まる
- そして認証が成功しログイン後の画面が表示される

このように、順々に処理が行われる物をひとまとめにして **シナリオ** といいます。一方で、「メールアドレスを入力する」、「ログインボタンを押す」、のような一つ一つの処理を **ステップ** といいます。複数のステップをまとめてシナリオとして、アプリケーションがシナリオ通りに動作するかをテストするのがKIFによる結合テストです。

それぞれの動作が正しく行われているかは、各ステップごとに判断を行います。次項以降で、シナリオとステップの書き方について解説を進めて行きます。


### KIFController


### Scenario

### Step

#### Accessibility Identifier の指定